// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String              @db.VarChar(150)
  email              String              @unique @db.VarChar(255)
  password_hash      String
  mobile             String              @unique @db.VarChar(15)
  referer_code       String?             @unique @db.VarChar(50)
  referred_by        String?             @db.VarChar(50) // Franchise referral code
  commission_rate    Decimal?            @db.Decimal(5, 2) // Commission rate % (default 5%)
  assigned_rates     Json?               // Per-service provider commission rates
  franchise_type     FranchiseType?      @default(DIRECT_SELLER)
  franchise_address  String?              @db.VarChar(500)
  franchise_pincode  String?              @db.VarChar(10)
  franchise_city     String?              @db.VarChar(100)
  franchise_state    String?              @db.VarChar(100)
  is_active          Boolean             @default(true)
  user_type          UserType            @default(NORMAL)
  wallet_balance     Decimal             @default(0) @db.Decimal(12, 2)
  created_at         DateTime            @default(now()) @db.Timestamp()
  updated_at         DateTime            @default(now()) @db.Timestamp()
  addresses          Address[]
  user_login_history UserLoginHistory[]
  orders             Order[]
  withdrawals        CommissionWithdrawal[]
  transactions       Transaction[]

  @@map("users")
}

model Transaction {
  id               String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id          String           @db.Uuid
  amount           Decimal          @db.Decimal(12, 2)
  type             TransactionType
  status           TransactionStatus @default(PENDING)
  description      String?          @db.VarChar(255)
  reference_id     String?          @db.VarChar(100) // External payment ID or Order ID
  created_at       DateTime         @default(now()) @db.Timestamp()
  updated_at       DateTime         @default(now()) @db.Timestamp()
  user             User             @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("transactions")
}

enum TransactionType {
  CREDIT
  DEBIT
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

model SystemSetting {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key         String   @unique @db.VarChar(50)
  value       String   @db.Text
  description String?  @db.VarChar(255)
  updated_at  DateTime @default(now()) @db.Timestamp()

  @@map("system_settings")
}

model Address {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id          String   @db.Uuid
  name             String   @db.VarChar(150)
  phone            String   @db.VarChar(15)
  email            String?  @db.VarChar(255)
  complete_address String
  city             String   @db.VarChar(100)
  state            String   @db.VarChar(100)
  pincode          String   @db.VarChar(10)
  country          String   @default("India") @db.VarChar(100)
  address_label    String?  @db.VarChar(50) // e.g., Home, Office
  is_shiprocket_pickup Boolean? @default(false)
  pickup_nickname  String?  @db.VarChar(50)
  is_default       Boolean? @default(false)
  created_at       DateTime @default(now()) @db.Timestamp()
  updated_at       DateTime @default(now()) @db.Timestamp()
  user             User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("addresses")
}

model UserLoginHistory {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id      String   @db.Uuid
  ip_address   String?  @db.Inet
  device_info  String?
  user_agent   String?
  login_status String   @db.VarChar(20)
  login_at     DateTime @default(now()) @db.Timestamp()
  user         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_login_history")
}

model Order {
  id                     BigInt                   @id @default(autoincrement())
  user_id                String                   @db.Uuid
  order_type             OrderType
  shipment_status        ShipmentStatus           @default(PENDING)
  shipment_type          ShipmentType
  payment_mode           PaymentMode
  total_amount           Decimal                  @db.Decimal(12, 2)
  product_amount         Decimal?                  @db.Decimal(12, 2)
  weight                 Decimal?                 @db.Decimal(10, 2)
  length                 Decimal?                 @db.Decimal(10, 2)
  width                  Decimal?                 @db.Decimal(10, 2)
  height                 Decimal?                 @db.Decimal(10, 2)
  courier_id             Int?
  courier_name           String?                  @db.VarChar(100)
  shipping_charge        Decimal?                 @db.Decimal(12, 2) // Final hiked price
  base_shipping_charge   Decimal?                 @db.Decimal(12, 2) // Base price
  global_commission_rate Decimal?                 @db.Decimal(5, 2)
  global_commission_amount Decimal?               @db.Decimal(12, 2)
  franchise_commission_rate Decimal?              @db.Decimal(5, 2)
  franchise_commission_amount Decimal?            @db.Decimal(12, 2)
  is_franchise_withdrawn      Boolean             @default(false)
  delivered_at                DateTime?           @db.Timestamp()    // Added delivered_at field
  created_at             DateTime                 @default(now()) @db.Timestamp()
  updated_at             DateTime                 @default(now()) @db.Timestamp()
  user                   User                     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  order_pickup_address   OrderPickupAddress?
  order_receiver_address OrderReceiverAddress?

  @@map("orders")
}

model OrderPickupAddress {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id BigInt  @unique
  name     String  @db.VarChar(150)
  phone    String  @db.VarChar(15)
  email    String? @db.VarChar(255)
  address  String
  city     String  @db.VarChar(100)
  state    String  @db.VarChar(100)
  pincode  String  @db.VarChar(10)
  country  String  @default("India") @db.VarChar(100)
  order    Order   @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@map("order_pickup_addresses")
}

model OrderReceiverAddress {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id BigInt  @unique
  name     String  @db.VarChar(150)
  phone    String  @db.VarChar(15)
  email    String? @db.VarChar(255)
  address  String
  city     String  @db.VarChar(100)
  state    String  @db.VarChar(100)
  pincode  String  @db.VarChar(10)
  country  String  @default("India") @db.VarChar(100)
  order    Order   @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@map("order_receiver_addresses")
}

model CommissionWithdrawal {
  id          String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String           @db.Uuid
  franchise_id String?         @db.Uuid
  amount      Decimal          @db.Decimal(12, 2)
  status      WithdrawalStatus @default(PENDING)
  created_at  DateTime         @default(now()) @db.Timestamp()
  updated_at  DateTime         @default(now()) @db.Timestamp()
  user        User             @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("commission_withdrawals")
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum UserType {
  ADMIN
  NORMAL
}

enum OrderType {
  SURFACE
  EXPRESS
}

enum ShipmentStatus {
  MANIFESTED
  IN_TRANSIT
  DISPATCHED
  DELIVERED
  NOT_PICKED
  PENDING
  CANCELLED
  RTO
}

enum ShipmentType {
  DOMESTIC
  INTERNATIONAL
}

enum PaymentMode {
  PREPAID
  COD
}

enum FranchiseType {
  DIRECT_SELLER
  DISTRIBUTOR
  PARTNER
}
