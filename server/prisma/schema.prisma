// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String              @db.VarChar(150)
  email              String              @unique @db.VarChar(255)
  password_hash      String
  mobile             String              @unique @db.VarChar(15)
  referer_code       String?             @unique @db.VarChar(50)
  referred_by        String?             @db.VarChar(50)
  commission_rate    Decimal?            @db.Decimal(5, 2)
  assigned_rates     Json?
  franchise_type     FranchiseType?      @default(DIRECT_SELLER)
  franchise_address  String?              @db.VarChar(500)
  franchise_pincode  String?              @db.VarChar(10)
  franchise_city     String?              @db.VarChar(100)
  franchise_state    String?              @db.VarChar(100)
  min_commission_rate Decimal?           @db.Decimal(5, 2)
  max_commission_rate Decimal?           @db.Decimal(5, 2)
  is_active          Boolean             @default(true)
  user_type          UserType            @default(NORMAL)
  wallet_balance     Decimal             @default(0) @db.Decimal(12, 2)
  pan_number         String?             @db.VarChar(10)
  pan_verified       Boolean             @default(false)
  aadhaar_number     String?             @db.VarChar(12)
  aadhaar_verified   Boolean             @default(false)
  gst_number         String?             @db.VarChar(15)
  gst_verified       Boolean             @default(false)
  kyc_status         KycStatus           @default(PENDING)
  created_at         DateTime            @default(now()) @db.Timestamp()
  updated_at         DateTime            @default(now()) @db.Timestamp()
  addresses          Address[]
  user_login_history UserLoginHistory[]
  orders             Order[]
  withdrawals        CommissionWithdrawal[]
  transactions       Transaction[]
  referral_commissions OrderReferralCommission[]

  @@map("users")
}

model Transaction {
  id               String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id          String           @db.Uuid
  amount           Decimal          @db.Decimal(12, 2)
  type             TransactionType
  category         TransactionCategory @default(WALLET_TOPUP)
  status           TransactionStatus @default(PENDING)
  status_reason    String?          @db.VarChar(500)
  description      String?          @db.VarChar(255)
  reference_id     String?          @db.VarChar(100)
  created_at       DateTime         @default(now()) @db.Timestamp()
  updated_at       DateTime         @default(now()) @db.Timestamp()
  user             User             @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("transactions")
}

enum TransactionType {
  CREDIT
  DEBIT
}

enum TransactionCategory {
  WALLET_TOPUP
  ORDER_PAYMENT
  REFUND
  COD_REMITTANCE
  COMMISSION
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

model SystemSetting {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key         String   @unique @db.VarChar(50)
  value       String   @db.Text
  description String?  @db.VarChar(255)
  updated_at  DateTime @default(now()) @db.Timestamp()

  @@map("system_settings")
}

model Address {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id          String   @db.Uuid
  name             String   @db.VarChar(150)
  phone            String   @db.VarChar(15)
  email            String?  @db.VarChar(255)
  complete_address String
  city             String   @db.VarChar(100)
  state            String   @db.VarChar(100)
  pincode          String   @db.VarChar(10)
  country          String   @default("India") @db.VarChar(100)
  address_label    String?  @db.VarChar(50) // e.g., Home, Office
  is_shiprocket_pickup Boolean? @default(false)
  pickup_nickname  String?  @db.VarChar(50)
  is_default       Boolean? @default(false)
  created_at       DateTime @default(now()) @db.Timestamp()
  updated_at       DateTime @default(now()) @db.Timestamp()
  user             User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("addresses")
}

model UserLoginHistory {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id      String   @db.Uuid
  ip_address   String?  @db.Inet
  device_info  String?
  user_agent   String?
  login_status String   @db.VarChar(20)
  login_at     DateTime @default(now()) @db.Timestamp()
  user         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_login_history")
}

model Order {
  id                     BigInt                   @id @default(autoincrement())
  user_id                String                   @db.Uuid
  order_type             OrderType
  shipment_status        ShipmentStatus           @default(PENDING)
  shipment_type          ShipmentType
  payment_mode           PaymentMode
  total_amount           Decimal                  @db.Decimal(12, 2)
  product_amount         Decimal?                  @db.Decimal(12, 2)
  products               Json?
  weight                 Decimal?                 @db.Decimal(10, 2)
  length                 Decimal?                 @db.Decimal(10, 2)
  width                  Decimal?                 @db.Decimal(10, 2)
  height                 Decimal?                 @db.Decimal(10, 2)
  courier_id             Int?
  courier_name           String?                  @db.VarChar(100)
  shipping_charge        Decimal?                 @db.Decimal(12, 2)
  base_shipping_charge   Decimal?                 @db.Decimal(12, 2)
  global_commission_rate Decimal?                 @db.Decimal(5, 2)
  global_commission_amount Decimal?               @db.Decimal(12, 2)
  franchise_commission_rate Decimal?              @db.Decimal(5, 2)
  franchise_commission_amount Decimal?            @db.Decimal(12, 2)
  is_franchise_withdrawn      Boolean             @default(false)
  delivered_at                DateTime?           @db.Timestamp()
  created_at             DateTime                 @default(now()) @db.Timestamp()
  updated_at             DateTime                 @default(now()) @db.Timestamp()
  user                   User                     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  order_pickup_address   OrderPickupAddress?
  order_receiver_address OrderReceiverAddress?
  shiprocket_order_id    String?                  @db.VarChar(50)
  shiprocket_shipment_id String?                  @db.VarChar(50)
  tracking_number        String?                  @db.VarChar(100)
  label_url              String?                  @db.Text
  manifest_url           String?                  @db.Text
  manifest_generated_at  DateTime?                @db.Timestamp()
  track_url              String?                  @db.Text
  rto_label_url          String?                  @db.Text()
  rto_charges           Decimal?                 @db.Decimal(12, 2)
  cod_amount            Decimal?                 @db.Decimal(12, 2)
  remittance_status     RemittanceStatus         @default(NOT_APPLICABLE)
  remittance_id         String?                  @db.VarChar(100)
  remitted_amount       Decimal?                 @db.Decimal(12, 2)
  remitted_at           DateTime?                @db.Timestamp()
  remittance_ref_id     String?                  @db.VarChar(100)
  shipment_history       ShipmentHistory[]
  referral_commissions   OrderReferralCommission[]

  @@map("orders")
}

model OrderPickupAddress {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id BigInt  @unique
  name     String  @db.VarChar(150)
  phone    String  @db.VarChar(15)
  email    String? @db.VarChar(255)
  address  String
  city     String  @db.VarChar(100)
  state    String  @db.VarChar(100)
  pincode  String  @db.VarChar(10)
  country  String  @default("India") @db.VarChar(100)
  order    Order   @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@map("order_pickup_addresses")
}

model OrderReceiverAddress {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id BigInt  @unique
  name     String  @db.VarChar(150)
  phone    String  @db.VarChar(15)
  email    String? @db.VarChar(255)
  address  String
  city     String  @db.VarChar(100)
  state    String  @db.VarChar(100)
  pincode  String  @db.VarChar(10)
  country  String  @default("India") @db.VarChar(100)
  order    Order   @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@map("order_receiver_addresses")
}

model CommissionWithdrawal {
  id          String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String           @db.Uuid
  franchise_id String?         @db.Uuid
  amount      Decimal          @db.Decimal(12, 2)
  status      WithdrawalStatus @default(PENDING)
  created_at  DateTime         @default(now()) @db.Timestamp()
  updated_at  DateTime         @default(now()) @db.Timestamp()
  user        User             @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("commission_withdrawals")
}

// Admin settings for multi-level referral commissions
model ReferralLevelSetting {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  max_levels  Int      // Maximum number of referral levels (e.g., 3 means Level 1, 2, 3)
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now()) @db.Timestamp()
  updated_at  DateTime @default(now()) @db.Timestamp()

  @@map("referral_level_settings")
}

// Track commissions for each order at each referral level
model OrderReferralCommission {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id        BigInt
  level           Int      // Which level this commission is for (1, 2, 3, etc.)
  referrer_id     String   @db.Uuid // User who receives this commission
  amount          Decimal  @db.Decimal(12, 2)
  is_withdrawn    Boolean  @default(false)
  withdrawn_at    DateTime?
  created_at      DateTime @default(now()) @db.Timestamp()
  updated_at      DateTime @default(now()) @db.Timestamp()
  order           Order    @relation(fields: [order_id], references: [id], onDelete: Cascade)
  referrer        User     @relation(fields: [referrer_id], references: [id], onDelete: Cascade)

  @@unique([order_id, level])
  @@map("order_referral_commissions")
}

model ShipmentHistory {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  order_id        BigInt
  status          String   @db.VarChar(50)
  status_date     DateTime @db.Timestamp()
  location        String?  @db.VarChar(200)
  shipment_status String?  @db.VarChar(50)
  activity        String?  @db.VarChar(255)
  created_at      DateTime @default(now()) @db.Timestamp()
  order           Order    @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@map("shipment_history")
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
  COMPLETED
}

enum UserType {
  ADMIN
  NORMAL
}

enum OrderType {
  SURFACE
  EXPRESS
}

enum ShipmentStatus {
  MANIFESTED
  IN_TRANSIT
  DISPATCHED
  DELIVERED
  NOT_PICKED
  PENDING
  CANCELLED
  RTO
}

enum ShipmentType {
  DOMESTIC
  INTERNATIONAL
}

enum PaymentMode {
  PREPAID
  COD
}

enum RemittanceStatus {
  NOT_APPLICABLE
  PENDING
  PROCESSING
  REMITTED
  FAILED
}

enum FranchiseType {
  DIRECT_SELLER
  DISTRIBUTOR
  PARTNER
}

enum KycStatus {
  PENDING
  SUBMITTED
  VERIFIED
  REJECTED
}

model OtpVerification {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email       String   @db.VarChar(255)
  mobile      String?  @db.VarChar(15)
  otp_code    String   @db.VarChar(6)
  purpose     String   @db.VarChar(50)
  expires_at  DateTime @db.Timestamp()
  verified    Boolean  @default(false)
  created_at  DateTime @default(now()) @db.Timestamp()

  @@index([email, purpose])
  @@index([mobile, purpose])
  @@map("otp_verifications")
}

model TempRegistrationData {
  id                String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email             String        @unique @db.VarChar(255)
  name              String        @db.VarChar(150)
  mobile            String        @db.VarChar(15)
  password_hash     String
  referred_by       String?       @db.VarChar(50)
  franchise_type    FranchiseType?
  franchise_address String?       @db.VarChar(500)
  franchise_pincode String?       @db.VarChar(10)
  franchise_city    String?       @db.VarChar(100)
  franchise_state   String?       @db.VarChar(100)
  commission_rate   Decimal?      @db.Decimal(5, 2)
  created_at        DateTime      @default(now()) @db.Timestamp()

  @@map("temp_registration_data")
}
